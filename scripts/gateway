#!/bin/bash
# Wrapper script para o Codex Gateway CLI

set -euo pipefail

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Configura√ß√µes
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLI_SCRIPT="$SCRIPT_DIR/gateway_cli.py"

# Gateway URL padr√£o
export GATEWAY_URL="${GATEWAY_URL:-https://localhost:3000}"

# Fun√ß√£o para exibir ajuda
show_help() {
    cat << EOF
üöÄ Codex Gateway CLI

USAGE:
    gateway [OPTIONS]

OPTIONS:
    -h, --help          Mostra esta mensagem de ajuda
    -u, --url URL       Define a URL do gateway (padr√£o: $GATEWAY_URL)
    -k, --key KEY       Define a API key manualmente
    --health            Verifica sa√∫de do gateway e sai

ENVIRONMENT VARIABLES:
    GATEWAY_URL         URL do gateway (padr√£o: https://localhost:3000)
    GATEWAY_KEY         API Key para autentica√ß√£o

EXAMPLES:
    # Uso b√°sico (usa secret manager automaticamente)
    gateway

    # Com API key manual
    gateway --key "sua-api-key"

    # Com URL customizada
    gateway --url "https://0.0.0.0:3000"

    # Verificar sa√∫de
    gateway --health

EOF
}

# Fun√ß√£o para health check
health_check() {
    echo -e "${YELLOW}üîç Verificando sa√∫de do gateway...${NC}"

    RESPONSE=$(curl -s "${GATEWAY_URL}/health" || echo "error")

    if [ "$RESPONSE" = "error" ]; then
        echo -e "${RED}‚ùå Gateway inacess√≠vel${NC}"
        exit 1
    fi

    STATUS=$(echo "$RESPONSE" | jq -r '.status' 2>/dev/null || echo "unknown")

    if [ "$STATUS" = "healthy" ]; then
        echo -e "${GREEN}‚úÖ Gateway est√° saud√°vel${NC}"
        echo -e "üì° URL: $GATEWAY_URL"
        exit 0
    else
        echo -e "${RED}‚ùå Gateway n√£o est√° saud√°vel${NC}"
        echo -e "üì¶ Resposta: $RESPONSE"
        exit 1
    fi
}

# Parse argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -u|--url)
            export GATEWAY_URL="$2"
            shift 2
            ;;
        -k|--key)
            export GATEWAY_KEY="$2"
            shift 2
            ;;
        --health)
            health_check
            ;;
        *)
            echo -e "${RED}‚ùå Argumento desconhecido: $1${NC}"
            echo "Use 'gateway --help' para ver op√ß√µes dispon√≠veis"
            exit 1
            ;;
    esac
done

# Verificar se Python est√° instalado
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå Python 3 n√£o encontrado. Por favor instale Python 3.${NC}"
    exit 1
fi

# Executar o CLI
exec python3 "$CLI_SCRIPT"
